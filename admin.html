<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Barber School</title>
    <style>
        :root { --dorado: #d4af37; --oscuro: #121212; --gris: #1e1e1e; --rojo: #ff4444; --azul: #0099ff; }
        body { font-family: sans-serif; background-color: var(--oscuro); color: white; padding: 20px; text-align: center; }
        
        .admin-panel {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--dorado);
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            margin: 0 auto 30px;
        }
        input, select { padding: 10px; border-radius: 5px; border: 1px solid #444; background: #000; color: white; margin: 5px; }
        button { background: var(--dorado); color: black; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        
        table { width: 100%; max-width: 950px; margin: 0 auto; border-collapse: collapse; background: var(--gris); border-radius: 10px; overflow: hidden; }
        th { background: var(--dorado); color: black; padding: 15px; }
        td { padding: 12px; border-bottom: 1px solid #333; }
        
        .badge-rol { padding: 4px 8px; border-radius: 5px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .rol-barbero { background: var(--azul); color: white; }
        .rol-estudiante { background: #444; color: #ccc; }

        .badge-deuda { color: var(--rojo); font-weight: bold; }
        .badge-pago { color: #44ff44; font-weight: bold; }
        
        .btn-pagar { background: #2e7d32; color: white; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-eliminar { background: var(--rojo); color: white; padding: 5px 10px; font-size: 0.8rem; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Panel Administrativo üíà</h1>
    <h2 style="color: var(--dorado); margin-bottom: 20px;">üìç Personas en el Local Ahora</h2>

    <div class="admin-panel">
        <h3>‚ûï Registrar Nuevo Miembro</h3>
        <input type="text" id="nuevoNombre" placeholder="Nombre Completo">
        <input type="number" id="nuevoDni" placeholder="DNI">
        <select id="nuevoRol">
            <option value="estudiante">Estudiante</option>
            <option value="barbero">Barbero</option>
        </select>
        <button onclick="registrarUsuario()">Guardar en Base de Datos</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Rol</th>
                <th>DNI</th>
                <th>Entrada</th>
                <th>Cuota</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-presentes"></tbody>
    </table>

    <script>
        async function cargarPresentes() {
            try {
                const res = await fetch('/api/presentes');
                const datos = await res.json();
                const tabla = document.getElementById('tabla-presentes');
                tabla.innerHTML = "";

                if (datos.length === 0) {
                    tabla.innerHTML = "<tr><td colspan='6' style='padding:20px; color:#888;'>No hay nadie presente en este momento.</td></tr>";
                    return;
                }

                datos.forEach(reg => {
                    const user = reg.users;
                    const pagado = user.cuota_pagada;
                    const rol = (user.role || 'estudiante').toLowerCase();
                    const hora = new Date(reg.check_in).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    tabla.innerHTML += `
                        <tr>
                            <td style="text-align: left; padding-left: 20px;">${user.full_name}</td>
                            <td><span class="badge-rol ${rol === 'barbero' ? 'rol-barbero' : 'rol-estudiante'}">${rol}</span></td>
                            <td>${reg.user_id}</td>
                            <td>${hora} hs</td>
                            <td>
                                ${rol === 'estudiante' 
                                    ? `<span class="${pagado ? 'badge-pago' : 'badge-deuda'}">${pagado ? 'Al D√≠a' : 'Pendiente'}</span>` 
                                    : '<span style="color:#888">Personal</span>'}
                            </td>
                            <td>
                                ${rol === 'estudiante' && !pagado ? `<button class="btn-pagar" onclick="marcarPago('${reg.user_id}')">üí∞ Pagar</button>` : ''}
                                <button class="btn-eliminar" onclick="eliminarUsuario('${reg.user_id}')">üóëÔ∏è Borrar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (err) { console.error("Error cargando tabla"); }
        }

        async function registrarUsuario() {
            const full_name = document.getElementById('nuevoNombre').value;
            const dni = document.getElementById('nuevoDni').value;
            const role = document.getElementById('nuevoRol').value;

            if(!full_name || !dni) return alert("Por favor, completa todos los campos.");

            const res = await fetch('/api/usuarios', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ full_name, dni, role })
            });
            const data = await res.json();

            if(data.success) {
                alert(`‚úÖ ${full_name} registrado correctamente como ${role}.`);
                document.getElementById('nuevoNombre').value = "";
                document.getElementById('nuevoDni').value = "";
                cargarPresentes();
            } else {
                alert("‚ùå Error: " + data.message);
            }
        }

        async function marcarPago(id) {
            if(!confirm("¬øConfirmar pago de cuota?")) return;
            const res = await fetch('/api/usuarios/pagar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id })
            });
            if(res.ok) {
                alert("‚úÖ Pago registrado con √©xito.");
                cargarPresentes();
            }
        }

        async function eliminarUsuario(id) {
            if(!confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? \nEsto eliminar√° permanentemente a la persona de la base de datos.")) return;
            
            const res = await fetch(`/api/usuarios/${id}`, {
                method: 'DELETE'
            });
            
            if(res.ok) {
                alert("üóëÔ∏è Usuario eliminado.");
                cargarPresentes();
            } else {
                alert("‚ùå No se pudo eliminar el usuario.");
            }
        }

        // Carga inicial y refresco cada 30 segundos
        cargarPresentes();
        setInterval(cargarPresentes, 30000);
    </script>
</body>
</html>
