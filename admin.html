<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SmartBarber</title>
    <style>
        :root { --dorado: #d4af37; --oscuro: #121212; --gris: #1e1e1e; --rojo: #ff4444; --verde: #4caf50; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--oscuro); color: white; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; text-align: center; }
        
        .admin-panel {
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid var(--dorado);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        input, select { padding: 10px; border-radius: 5px; border: 1px solid #444; background: #000; color: white; margin: 5px; }
        button { background: var(--dorado); color: black; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        
        .search-container { margin-bottom: 20px; text-align: left; }
        #buscador { width: 100%; max-width: 300px; border-color: var(--dorado); padding: 12px; }

        table { width: 100%; border-collapse: collapse; background: var(--gris); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        th { background: var(--dorado); color: black; padding: 15px; }
        td { padding: 12px; border-bottom: 1px solid #333; text-align: center; }
        
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .bg-si { background: var(--verde); color: white; }
        .bg-no { background: var(--rojo); color: white; }
        .vencimiento-texto { font-size: 0.9rem; font-weight: bold; }

        /* Estilos de botones de acci√≥n */
        .btn-renovar { background: var(--verde); color: white; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }
        .btn-eliminar { background: var(--rojo); color: white; padding: 5px 10px; font-size: 0.8rem; }
        .btn-eliminar:hover { background: #cc0000; }
    </style>
</head>
<body>

<div class="container">
    <h1>Panel Administrativo üíà</h1>
    
    <div class="admin-panel">
        <h3>‚ûï Registrar Nuevo Miembro</h3>
        <input type="text" id="nuevoNombre" placeholder="Nombre Completo">
        <input type="number" id="nuevoDni" placeholder="DNI">
        <select id="nuevoRol">
            <option value="Estudiante">Estudiante</option>
            <option value="Barbero">Barbero</option>
        </select>
        <button onclick="registrarUsuario()">GUARDAR</button>
    </div>

    <div class="search-container">
        <h2>üìç Lista de Miembros</h2>
        <input type="text" id="buscador" onkeyup="filtrarTabla()" placeholder="üîç Buscar por nombre o DNI...">
        <button onclick="cargarMiembros()" style="background: #444; color: white;">üîÑ Sincronizar</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>DNI</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Cuota</th>
                <th>Vencimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-miembros">
            <tr><td colspan="6">Cargando datos...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzdIQm3sITKDmYmMqabIV5D4TMkruS1Qrbj3XIo_Amx6iGfgWWdfwoZ-pc6BodKUvd8Vg/exec";
    let miembrosCache = []; 

    async function cargarMiembros() {
        const tabla = document.getElementById('tabla-miembros');
        try {
            const res = await fetch(`${WEB_APP_URL}?action=getList&t=${Date.now()}`);
            miembrosCache = await res.json();
            renderizarTabla(miembrosCache);
        } catch (e) {
            tabla.innerHTML = "<tr><td colspan='6'>Error al conectar con Google Sheets</td></tr>";
        }
    }

    function renderizarTabla(datos) {
        const tabla = document.getElementById('tabla-miembros');
        tabla.innerHTML = "";
        datos.forEach(m => {
            const badgeClass = m.cuota.toUpperCase() === 'SI' ? 'bg-si' : 'bg-no';
            const fechaColor = m.cuota.toUpperCase() === 'NO' ? 'var(--rojo)' : '#aaa';
            
            tabla.innerHTML += `
                <tr>
                    <td>${m.dni}</td>
                    <td style="text-align: left;">${m.nombre}</td>
                    <td>${m.rol}</td>
                    <td><span class="badge ${badgeClass}">${m.cuota}</span></td>
                    <td class="vencimiento-texto" style="color: ${fechaColor};">${m.vencimiento || '---'}</td>
                    <td>
                        <button class="btn-renovar" onclick="renovarCuota('${m.dni}', '${m.nombre}')">‚ûï PAGO (+30d)</button>
                        <button class="btn-eliminar" onclick="eliminarMiembro('${m.dni}', '${m.nombre}')">üóëÔ∏è Borrar</button>
                    </td>
                </tr>
            `;
        });
    }

    async function renovarCuota(dni, nombre) {
        if(!confirm(`¬øDeseas registrar pago para ${nombre}? Se sumar√°n 30 d√≠as a su vencimiento actual.`)) return;
        try {
            const url = `${WEB_APP_URL}?action=renew&dni=${dni}`;
            await fetch(url);
            alert("‚úÖ Cuota renovada con √©xito");
            cargarMiembros();
        } catch (e) {
            alert("Error al renovar. Reintenta en unos segundos.");
        }
    }

    function filtrarTabla() {
        const busqueda = document.getElementById('buscador').value.toLowerCase();
        const filtrados = miembrosCache.filter(m => 
            m.nombre.toLowerCase().includes(busqueda) || 
            m.dni.toString().includes(busqueda)
        );
        renderizarTabla(filtrados);
    }

    async function eliminarMiembro(dni, nombre) {
        if(!confirm(`¬øEst√°s seguro de eliminar a ${nombre}?`)) return;
        try {
            const url = `${WEB_APP_URL}?action=delete&dni=${dni}`;
            await fetch(url);
            alert("Eliminado correctamente");
            cargarMiembros();
        } catch (e) {
            alert("Solicitud enviada. Refresca la lista.");
            cargarMiembros();
        }
    }

    async function registrarUsuario() {
        const nombre = document.getElementById('nuevoNombre').value;
        const dni = document.getElementById('nuevoDni').value;
        const rol = document.getElementById('nuevoRol').value;

        if(!nombre || !dni) return alert("Completa todos los campos");

        // C√°lculo de fecha autom√°tica: hoy + 30 d√≠as
        const hoy = new Date();
        const vencimientoAuto = new Date(hoy.getFullYear(), hoy.getMonth() + 1, hoy.getDate()).toISOString().split('T')[0];

        try {
            const url = `${WEB_APP_URL}?action=add&nombre=${encodeURIComponent(nombre)}&dni=${dni}&rol=${rol}&vencimiento=${vencimientoAuto}`;
            await fetch(url);
            alert("‚úÖ Guardado con √©xito. Vencimiento: " + vencimientoAuto);
            document.getElementById('nuevoNombre').value = "";
            document.getElementById('nuevoDni').value = "";
            cargarMiembros(); 
        } catch (e) {
            alert("Registro enviado. Refresca la lista.");
            cargarMiembros();
        }
    }

    window.onload = cargarMiembros;
</script>

</body>
</html>
